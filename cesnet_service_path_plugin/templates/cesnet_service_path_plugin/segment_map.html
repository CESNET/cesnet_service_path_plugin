{% extends 'generic/object.html' %}
{% load static %}
{% load helpers %}

{% block title %}{{ object.name }} - Map View{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="mdi mdi-map" aria-hidden="true"></i>
                    Map: {{ object.name }}
                </h5>
                <div class="card-actions">
                    <a href="{{ object.get_absolute_url }}" class="btn btn-outline-secondary btn-sm">
                        <i class="mdi mdi-arrow-left" aria-hidden="true"></i> Back to Segment
                    </a>
                    <a href="{% url 'plugins:cesnet_service_path_plugin:segment_geojson_download' pk=object.pk %}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="mdi mdi-download" aria-hidden="true"></i> Download GeoJSON
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if not object.has_path_data and not object.site_a.latitude %}
                    <div class="alert alert-warning" role="alert">
                        <i class="mdi mdi-alert-circle" aria-hidden="true"></i>
                        This segment does not have path data and site coordinates are not available.
                    </div>
                {% else %}
                    <!-- Segment info -->
                    <div class="alert alert-info mb-3">
                        <strong>{{ object.provider }}</strong> | 
                        <span class="badge text-bg-{{ object.get_status_color }}">{{ object.get_status_display }}</span> | 
                        {% if object.path_length_km %}{{ object.path_length_km }} km{% else %}Length unknown{% endif %} | 
                        {{ object.site_a }} ↔ {{ object.site_b }}
                        {% if object.site_a.latitude and object.site_a.longitude %}
                            {{ object.site_a.latitude }}, {{ object.site_a.longitude }} ↔ 
                            {{ object.site_b.latitude }}, {{ object.site_b.longitude }}
                        {% endif %}
                    </div>
                    
                    <!-- Map controls -->
                    <div class="mb-3">
                        <button id="fitBounds" class="btn btn-sm btn-outline-primary">
                            <i class="mdi mdi-fit-to-page-outline"></i> Fit to Path
                        </button>
                        <button id="toggleLayer" class="btn btn-sm btn-outline-secondary">
                            <i class="mdi mdi-satellite-variant"></i> Satellite
                        </button>
                    </div>
                    
                    <!-- Map container -->
                    <div id="map" style="height: 600px; width: 100%; border: 1px solid #ddd; border-radius: 4px;"></div>
                    
                    <!-- Load Leaflet -->
                    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
                    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

                    <script>
                    
                    // Create map
                    const map = L.map('map').setView([49.75, 15.5], 7);
                    
                    // Add tile layers
                    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    });
                    
                    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles © Esri'
                    });
                    
                    // Start with OSM
                    osmLayer.addTo(map);
                    let currentLayer = osmLayer;
                    
                    // Site coordinates
                    const siteA = { 
                        lat: {{ object.site_a.latitude|default:"null" }}, 
                        lng: {{ object.site_a.longitude|default:"null" }},
                        name: "{{ object.site_a }}"
                    };
                    const siteB = { 
                        lat: {{ object.site_b.latitude|default:"null" }}, 
                        lng: {{ object.site_b.longitude|default:"null" }},
                        name: "{{ object.site_b }}"
                    };
                    
                    // Status colors
                    const statusColors = {
                        'Active': '#dc3545',     // Red (changed from green for better visibility)
                        'Planned': '#ffc107',    // Yellow
                        'Offline': '#6c757d'     // Gray
                    };
                    
                    // Get segment color based on status
                    const segmentColor = statusColors['{{ object.get_status_display }}'] || '#dc3545';
                    
                    // Function to add site markers
                    function addSiteMarkers() {
                        if (siteA.lat && siteA.lng) {
                            const markerA = L.circleMarker([siteA.lat, siteA.lng], {
                                radius: 8,
                                fillColor: '#007bff',
                                color: '#ffffff',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            }).addTo(map);
                            
                            markerA.bindPopup(`
                                <div>
                                    <h6>${siteA.name}</h6>
                                    <p><strong>Type:</strong> Start Site</p>
                                    <p><strong>Coordinates:</strong> ${siteA.lat}, ${siteA.lng}</p>
                                </div>
                            `);
                        }
                        
                        if (siteB.lat && siteB.lng) {
                            const markerB = L.circleMarker([siteB.lat, siteB.lng], {
                                radius: 8,
                                fillColor: '#28a745',
                                color: '#ffffff',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            }).addTo(map);
                            
                            markerB.bindPopup(`
                                <div>
                                    <h6>${siteB.name}</h6>
                                    <p><strong>Type:</strong> End Site</p>
                                    <p><strong>Coordinates:</strong> ${siteB.lat}, ${siteB.lng}</p>
                                </div>
                            `);
                        }
                    }
                    
                    // Function to create straight line fallback
                    function createStraightLine() {
                        if (siteA.lat && siteA.lng && siteB.lat && siteB.lng) {
                            const straightLine = L.polyline([
                                [siteA.lat, siteA.lng],
                                [siteB.lat, siteB.lng]
                            ], {
                                color: segmentColor,
                                weight: 4,
                                opacity: 0.8,
                                dashArray: '10, 5' // Dashed line to indicate it's a fallback
                            }).addTo(map);
                            
                            straightLine.bindPopup(`
                                <div>
                                    <h6>{{ object.name }}</h6>
                                    <p><strong>Provider:</strong> {{ object.provider }}</p>
                                    <p><strong>Status:</strong> {{ object.get_status_display }}</p>
                                    <p><strong>Route:</strong> {{ object.site_a }} ↔ {{ object.site_b }}</p>
                                    <p><em>Note: Showing straight line (no path data available)</em></p>
                                </div>
                            `);
                            
                            // Fit to straight line
                            setTimeout(() => {
                                map.fitBounds(straightLine.getBounds(), {padding: [50, 50]});
                            }, 100);
                            
                            // Store for controls
                            window.pathLayer = straightLine;
                        }
                    }
                    
                    // Load segment path or create fallback
                    {% if object.has_path_data %}
                    fetch('{% url "plugins:cesnet_service_path_plugin:segment_geojson_api" pk=object.pk %}')
                        .then(response => response.json())
                        .then(data => {
                            
                            if (data.features && data.features.length > 0) {
                                const feature = data.features[0];
                                
                                // Add path to map
                                const pathLayer = L.geoJSON(data, {
                                    style: {
                                        color: segmentColor,
                                        weight: 4,
                                        opacity: 0.8,
                                        dashArray: feature.properties.status === 'Offline' ? '10, 5' : null
                                    }
                                }).addTo(map);
                                
                                // Add popup
                                pathLayer.bindPopup(`
                                    <div>
                                        <h6>{{ object.name }}</h6>
                                        <p><strong>Provider:</strong> {{ object.provider }}</p>
                                        <p><strong>Status:</strong> {{ object.get_status_display }}</p>
                                        {% if object.path_length_km %}<p><strong>Length:</strong> {{ object.path_length_km }} km</p>{% endif %}
                                        <p><strong>Route:</strong> {{ object.site_a }} ↔ {{ object.site_b }}</p>
                                    </div>
                                `);
                                
                                // Add site markers
                                addSiteMarkers();
                                
                                // Fit to path
                                setTimeout(() => {
                                    map.fitBounds(pathLayer.getBounds(), {padding: [20, 20]});
                                }, 100);
                                
                                // Store for controls
                                window.pathLayer = pathLayer;

                            } else {
                                console.log('No path features found, using straight line fallback');
                                createStraightLine();
                                addSiteMarkers();
                            }
                        })
                        .catch(error => {
                            console.error('Error loading path:', error);
                            console.log('Using straight line fallback due to error');
                            createStraightLine();
                            addSiteMarkers();
                        });
                    {% else %}
                        // No path data, create straight line if coordinates available
                        createStraightLine();
                        addSiteMarkers();
                    {% endif %}
                    
                    // Control handlers
                    document.getElementById('fitBounds').onclick = function() {
                        if (window.pathLayer) {
                            map.fitBounds(window.pathLayer.getBounds(), {padding: [20, 20]});
                        }
                    };
                    
                    document.getElementById('toggleLayer').onclick = function() {
                        if (currentLayer === osmLayer) {
                            map.removeLayer(osmLayer);
                            map.addLayer(satelliteLayer);
                            currentLayer = satelliteLayer;
                            this.innerHTML = '<i class="mdi mdi-earth"></i> Street Map';
                        } else {
                            map.removeLayer(satelliteLayer);
                            map.addLayer(osmLayer);
                            currentLayer = osmLayer;
                            this.innerHTML = '<i class="mdi mdi-satellite-variant"></i> Satellite';
                        }
                    };
                    </script>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}